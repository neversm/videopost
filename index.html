<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDiary</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        /* --- Base & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #0d0d0d; color: #fff; overflow-x: hidden; }
        
        /* --- Menu Bar --- */
        .menu-bar { 
            height: 100vh; width: 14em; position: fixed; z-index: 100; top: 0; left: 0; 
            background-color: #000; padding-bottom: 2em; display: flex; flex-direction: column; 
            border-right: 1px solid #282828; transition: all 0.3s ease; overflow: hidden; white-space: nowrap; 
        }
        .menu-bar.minimized { width: 0; padding: 0; border: none; }
        .menu-bar img { height: 5.0em; width: 5.0em; margin: 1em auto; display: block; object-fit: contain; }
        .menu-bar nav ul { padding: 0; margin: 0; list-style: none; }
        .menu-bar nav ul li { margin: 0.8em 0; }
        .menu-bar nav ul li a { text-decoration: none; color: #cccccc; padding: .5em 0 .5em 1.2em; display: flex; align-items: center; transition: color 0.2s ease; cursor: pointer; }
        .menu-bar nav ul li a:hover, .menu-bar nav ul li a.active { color: #fff; background-color: #1a1a1a; border-left: 4px solid #1db954; }
        .menu-bar nav ul li a i { margin-right: 1em; width: 1.2em; text-align: center; }
        .menu-bar .user-collection { margin-top: 1.5em; border-top: 1px solid #282828; padding-top: 1em; }

        /* --- Main Content --- */
        .main-content { margin-left: 14em; min-height: 100vh; display: flex; flex-direction: column; transition: margin-left 0.3s ease; }
        .main-content.full-width { margin-left: 0; }
        .main-content header { background-color: rgba(10, 10, 10, 0.9); backdrop-filter: blur(8px); padding: 0.8em 1.5em; position: sticky; top: 0; z-index: 90; display: flex; justify-content: space-between; align-items: center; min-height: 4.5em; border-bottom: 1px solid #282828; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #555; display: inline-block; margin-right: 5px;}
        .status-dot.online { background-color: #1db954; box-shadow: 0 0 5px #1db954; }
        .status-dot.error { background-color: #dc3545; }
        #settingsToggle { border: none; background: none; color: #fff; cursor: pointer; font-size: 1.2em; }
        #settingsMenu { position: absolute; top: 4.5em; right: 1.5em; background-color: #282828; padding: 10px 0; display: none; z-index: 1000; width: 200px; border: 1px solid #444; border-radius: 4px; }
        #settingsMenu ul { list-style: none; }
        #settingsMenu ul li a { text-decoration: none; color: #eee; display: block; padding: 10px 20px; }
        #settingsMenu ul li a:hover { background-color: #404040; }
        .main-content main { padding: 1.5em; flex-grow: 1; }
        .greeting h2 { font-weight: bold; margin-bottom: 1em; font-size: 1.8em; }

        /* --- Search Bar --- */
        #searchBarContainer { background-color: #181818; padding: 1em; margin-bottom: 1em; border-radius: 0.5em; border: 1px solid #333; display: none; align-items: center; gap: 10px; }
        #searchInput { flex-grow: 1; background: #111; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; }
        #closeSearchBtn { background: none; border: none; color: #aaa; font-size: 1.2em; cursor: pointer; }

        /* --- Editor --- */
        .text-editor { background-color: #181818; padding: 1em; border-radius: .5em; margin-bottom: 1.5em; position: relative; border: 1px solid #282828; transition: all 0.3s ease; }
        .text-editor.locked-hidden { display: none; }
        .ql-toolbar { background-color: #282828; border-color: #444 !important; border-radius: 5px 5px 0 0; }
        .ql-container { background-color: #202020; border-color: #444 !important; border-radius: 0 0 5px 5px; color: #fff; min-height: 120px; font-size: 16px; }
        .ql-stroke { stroke: #ccc !important; } .ql-fill { fill: #ccc !important; } .ql-picker { color: #ccc !important; }
        .editor-buttons { display: flex; justify-content: space-between; margin-top: 1em; align-items: center; flex-wrap: wrap; gap: 10px; }
        .upload-buttons button, .action-buttons button { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; color: #fff; font-size: 0.9em; }
        #uploadVideoButton { background-color: #0d6efd; } #uploadImageButton { background-color: #ffc107; color: #000; } #uploadFileButton { background-color: #6f42c1; }
        .file-selected { border: 2px solid #fff; }
        #postButton { background-color: #1db954; padding: 8px 25px; } #postButton:hover { background-color: #1ed760; }
        #updateButton { background-color: #1db954; display: none; } #cancelEditButton { background-color: #6c757d; display: none; }

        /* --- Posts Grid (Fixed Height) --- */
        #postContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5em; }
        .post { 
            background-color: #181818; border-radius: .5em; padding: 1em; 
            display: flex; flex-direction: column; position: relative; border: 1px solid #282828; 
            height: 200px; /* FIXED HEIGHT */
            overflow: hidden; 
        }
        .post-content { 
            margin-bottom: 2em; word-wrap: break-word; color: #ddd; 
            flex-grow: 1; 
            overflow-y: auto; /* SCROLL IF TEXT LONG */
            scrollbar-width: thin; scrollbar-color: #444 #181818;
        }
        .post-content::-webkit-scrollbar { width: 6px; }
        .post-content::-webkit-scrollbar-thumb { background-color: #444; border-radius: 3px; }

        /* Media Sizing in Post */
        .post-content img, .post-content video { 
            display: block;
            margin: 10px 0;
            max-height: 100px; /* Constrain height so text fits */
            max-width: 100%;
            width: auto;
            border-radius: 4px; 
            background: #000; 
            cursor: zoom-in; /* Indicate clickable */
        }
        
        .post-actions { position: absolute; bottom: 0.5em; left: 1em; right: 1em; display: flex; justify-content: space-between; align-items: center; color: #888; font-size: 0.9em; background: #181818; padding-top: 5px; }
        .post-buttons { display: flex; gap: 10px; }
        .post-buttons button { background: none; border: none; color: #888; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .post-buttons button:hover { color: #fff; }
        .post-buttons .heart-button.liked { color: #ff3333; }
        .post-buttons .delete-button:hover { color: #dc3545; }

        /* --- Library Grid --- */
        #libraryGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5em; margin-top: 20px; }
        .playlist-card { background-color: #181818; border: 1px solid #333; padding: 20px; border-radius: 8px; cursor: pointer; transition: background 0.2s; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; }
        .playlist-card:hover { background-color: #222; border-color: #555; }
        .playlist-card i { font-size: 3em; margin-bottom: 15px; color: #444; }
        .playlist-card h3 { font-size: 1.1em; margin-bottom: 5px; }
        .create-card { border: 2px dashed #444; background: transparent; }
        .create-card:hover { border-color: #1db954; background: rgba(29, 185, 84, 0.05); }
        .create-card i { color: #1db954; }

        /* --- Modals --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(2px); align-items: center; justify-content: center; }
        .modal-content { background-color: #222; padding: 2em; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #444; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 15px; color: #fff; }
        .modal-content input[type="text"], .modal-content input[type="password"] { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; margin-bottom: 15px; }
        #playlistSelectionList { text-align: left; margin-bottom: 15px; border: 1px solid #333; max-height: 150px; overflow-y: scroll; padding: 10px; border-radius: 4px; }
        .playlist-option { display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid #333; }
        .playlist-option label { cursor: pointer; font-size: 0.9em; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal-footer button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-primary { background-color: #1db954; color: white; }
        .btn-secondary { background-color: #555; color: white; }
        .close { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 24px; cursor: pointer; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; border-color: #ff3333 !important; }

        /* --- Media Lightbox Modal --- */
        #mediaModal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); align-items: center; justify-content: center; }
        #mediaContainer { max-width: 90%; max-height: 90%; }
        #mediaContainer img, #mediaContainer video { max-width: 100%; max-height: 90vh; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        @media (max-width: 768px) {
            .menu-bar { transform: translateX(-100%); width: 0; padding: 0; border: none; } 
            .menu-bar.open { transform: translateX(0); width: 14em; padding-bottom: 2em; border-right: 1px solid #282828; }
            .main-content { margin-left: 0; }
            #postContainer { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Lightbox -->
    <div id="mediaModal" onclick="this.style.display='none'">
        <div id="mediaContainer"></div>
    </div>

    <!-- Menu Bar -->
    <div class="menu-bar" id="menuBar">
        <img src="https://images.icon-icons.com/1520/PNG/512/videoplayflat_106010.png" alt="Logo">
        <nav>
            <ul>
                <li><a onclick="setView('home')" class="active"><i class="fas fa-home"></i>Home</a></li>
                <li><a onclick="toggleSearch()"><i class="fas fa-search"></i>Search</a></li>
                <li><a onclick="setView('library')"><i class="fas fa-book"></i>Your Library</a></li>
            </ul>
        </nav>
        <div class="user-collection">
            <nav>
                <ul>
                    <li><a onclick="openPlaylistModal()"><i class="fas fa-plus-square"></i>Create Playlist</a></li>
                    <li><a onclick="setView('liked')"><i class="fas fa-heart"></i>Liked Posts</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <header>
            <div class="hamburger" id="hamburger" onclick="toggleMenu()" style="cursor:pointer; color:white; font-size:1.5em;">
                <i class="fas fa-bars"></i>
            </div>
            <div class="header-controls">
                <div style="color:#888; font-size:0.9em;"><span class="status-dot" id="statusDot"></span> <span id="statusText">Offline</span></div>
                <button id="settingsToggle"><i class="fas fa-cog"></i></button>
            </div>
        </header>
        
        <div id="settingsMenu">
            <ul>
                <li><a href="#" onclick="openGithubSetup()">Cloud Setup (GitHub)</a></li>
                <li><a href="#" onclick="logout()">Disconnect Cloud</a></li>
            </ul>
        </div>

        <main>
            <div class="greeting"><h2 id="pageTitle">Home</h2></div>

            <!-- Search Bar -->
            <div id="searchBarContainer">
                <i class="fas fa-search" style="color:#888;"></i>
                <input type="text" id="searchInput" placeholder="Search posts content or date...">
                <button id="closeSearchBtn" title="Close Search"><i class="fas fa-times"></i></button>
            </div>

            <!-- Views -->
            <div id="mainView">
                <div class="text-editor locked-hidden" id="mainTextEditor">
                    <div id="editor"></div>
                    <input type="file" id="videoUpload" accept="video/*" style="display: none;">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <input type="file" id="fileUpload" accept=".pdf,.txt,.doc,.docx" style="display: none;">
                    <div class="editor-buttons">
                        <div class="upload-buttons">
                            <button id="uploadVideoButton" onclick="triggerUpload('video')"><i class="fas fa-video"></i> Video</button>
                            <button id="uploadImageButton" onclick="triggerUpload('image')"><i class="fas fa-image"></i> Image</button>
                            <button id="uploadFileButton" onclick="triggerUpload('file')"><i class="fas fa-paperclip"></i> File</button>
                        </div>
                        <div class="action-buttons">
                            <button id="cancelEditButton" onclick="cancelEdit()">Cancel</button>
                            <button id="updateButton" onclick="savePost()">Update</button>
                            <button id="postButton" onclick="savePost()">Post</button>
                        </div>
                    </div>
                </div>
                <div id="postContainer"></div>
            </div>

            <div id="libraryView" style="display:none;">
                <div id="libraryGrid"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="hiddenPasscodeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('hiddenPasscodeModal').style.display='none'">&times;</span>
            <h2>Security Access</h2>
            <input type="password" id="hiddenPasscodeInput" maxlength="4" placeholder="" style="text-align:center; font-size:1.5em; letter-spacing:5px;">
            <div class="modal-footer"><button class="btn-primary" id="submitHiddenPasscode">Submit</button></div>
        </div>
    </div>
    <div id="githubModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('githubModal')">&times;</span>
            <h2>Cloud Setup</h2>
            <p style="font-size:0.8em; color:#ccc; margin-bottom:15px;">GitHub Personal Access Token (Scope: gist)</p>
            <input type="password" id="ghToken" placeholder="Access Token">
            <input type="text" id="ghGistId" placeholder="Gist ID (Optional)">
            <div class="modal-footer"><button class="btn-secondary" onclick="closeModal('githubModal')">Cancel</button><button class="btn-primary" onclick="connectToGithub()">Connect</button></div>
        </div>
    </div>
    <div id="playlistModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('playlistModal')">&times;</span>
            <h2>Create Playlist</h2>
            <input type="text" id="playlistNameInput" placeholder="Playlist Name">
            <p style="text-align:left; font-size:0.9em; color:#aaa; margin-bottom:5px;">Select Posts:</p>
            <div id="playlistSelectionList"></div>
            <div class="modal-footer"><button class="btn-secondary" onclick="closeModal('playlistModal')">Cancel</button><button class="btn-primary" onclick="savePlaylist()">Save Playlist</button></div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let appData = { posts: [], playlists: [], liked: [] };
        let config = { token: '', gistId: '' };
        let editingId = null;
        let tempBase64 = null;
        let tempMediaType = null;
        let isLocked = true; 
        let currentFilter = null; 
        let isMenuMinimized = false;

        const quill = new Quill('#editor', {
            theme: 'snow', placeholder: 'Write something...',
            modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'clean']] }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const storedConfig = localStorage.getItem('gh_config');
            if (storedConfig) { config = JSON.parse(storedConfig); fetchFromGithub(); } 
            else { document.getElementById('statusDot').classList.add('error'); }
            applyLockState(); 
        });

        // --- View & Menu Logic ---
        function toggleMenu() {
            const menu = document.getElementById('menuBar');
            const content = document.getElementById('mainContent');
            const isMobile = window.innerWidth <= 768;
            if (isMobile) { menu.classList.toggle('open'); } 
            else { 
                isMenuMinimized = !isMenuMinimized;
                if(isMenuMinimized) { menu.classList.add('minimized'); content.classList.add('full-width'); } 
                else { menu.classList.remove('minimized'); content.classList.remove('full-width'); }
            }
        }

        // --- Passcode Logic ---
        const editorDiv = document.getElementById('mainTextEditor');
        const hiddenModal = document.getElementById('hiddenPasscodeModal');
        const passInput = document.getElementById('hiddenPasscodeInput');
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && (e.key === 'Q' || e.key === 'q')) {
                e.preventDefault(); hiddenModal.style.display = 'flex'; passInput.value = ''; setTimeout(() => passInput.focus(), 100);
            }
        });
        document.getElementById('submitHiddenPasscode').addEventListener('click', validatePasscode);
        passInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') validatePasscode(); });
        function validatePasscode() {
            const code = passInput.value;
            if (code === '1011') { isLocked = false; hiddenModal.style.display = 'none'; applyLockState(); } 
            else if (code === '1110') { isLocked = true; hiddenModal.style.display = 'none'; applyLockState(); } 
            else { passInput.classList.add('shake'); setTimeout(() => passInput.classList.remove('shake'), 300); passInput.value = ''; }
        }
        function applyLockState() {
            if (isLocked) editorDiv.classList.add('locked-hidden'); else editorDiv.classList.remove('locked-hidden');
            renderPosts(); 
        }

        // --- Search ---
        function toggleSearch() {
            const sb = document.getElementById('searchBarContainer');
            if (sb.style.display === 'flex') { sb.style.display = 'none'; document.getElementById('searchInput').value = ''; renderPosts(); } 
            else { sb.style.display = 'flex'; document.getElementById('searchInput').focus(); }
            document.getElementById('menuBar').classList.remove('open');
        }
        document.getElementById('closeSearchBtn').addEventListener('click', toggleSearch);
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderPosts(post => post.content.toLowerCase().includes(term) || post.date.toLowerCase().includes(term));
        });

        // --- Post/Media Logic ---
        function triggerUpload(type) { document.getElementById(`${type}Upload`).click(); }
        ['video', 'image', 'file'].forEach(type => {
            document.getElementById(`${type}Upload`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    tempBase64 = evt.target.result; tempMediaType = type;
                    document.querySelectorAll('.upload-buttons button').forEach(b => b.classList.remove('file-selected'));
                    document.getElementById(`upload${type.charAt(0).toUpperCase() + type.slice(1)}Button`).classList.add('file-selected');
                };
                reader.readAsDataURL(file);
            });
        });

        function enlargeMedia(id, type) {
            const post = appData.posts.find(p => p.id === id);
            if(!post || !post.media) return;
            const container = document.getElementById('mediaContainer');
            container.innerHTML = '';
            if(type === 'image') container.innerHTML = `<img src="${post.media}">`;
            else if(type === 'video') container.innerHTML = `<video src="${post.media}" controls autoplay></video>`;
            document.getElementById('mediaModal').style.display = 'flex';
        }

        function savePost() {
            if(!config.token) return alert("You are offline.");
            const content = quill.root.innerHTML; const textRaw = quill.getText().trim();
            if (!textRaw && !tempBase64 && !content.includes('<img')) return alert("Post is empty!");
            const post = { id: editingId || Date.now(), content: content, media: tempBase64, mediaType: tempMediaType, date: new Date().toLocaleString() };
            if (editingId) { const idx = appData.posts.findIndex(p => p.id === editingId); if(idx > -1) appData.posts[idx] = post; cancelEdit(); } 
            else { appData.posts.unshift(post); }
            quill.setContents([]); tempBase64 = null; tempMediaType = null;
            document.querySelectorAll('.upload-buttons button').forEach(b => b.classList.remove('file-selected'));
            renderPosts(); saveToGithub();
        }

        function renderPosts(filterFn = null) {
            const container = document.getElementById('postContainer'); container.innerHTML = '';
            let postsToRender = appData.posts;
            if (filterFn) postsToRender = postsToRender.filter(filterFn);
            else if (currentFilter === 'liked') postsToRender = postsToRender.filter(p => appData.liked.includes(p.id));

            if(postsToRender.length === 0) { container.innerHTML = '<p style="color:#555; text-align:center; grid-column: 1/-1;">No posts found.</p>'; return; }

            postsToRender.forEach(post => {
                const div = document.createElement('div'); div.className = 'post';
                let mediaHtml = '';
                if (post.media) {
                    if (post.mediaType === 'image') mediaHtml = `<img src="${post.media}" onclick="enlargeMedia(${post.id}, 'image')">`;
                    else if (post.mediaType === 'video') mediaHtml = `<video src="${post.media}" onclick="enlargeMedia(${post.id}, 'video')"></video>`;
                    else if (post.mediaType === 'file') mediaHtml = `<div style="margin-top:10px;"><a href="${post.media}" download="file" style="color:#1db954; text-decoration:none;"><i class="fas fa-file-download"></i> Download Attachment</a></div>`;
                }
                const isLiked = appData.liked.includes(post.id);
                let buttonsHtml = !isLocked ? `
                    <div class="post-buttons">
                        <button class="heart-button ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id})"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i></button>
                        <button onclick="editPost(${post.id})"><i class="fas fa-edit"></i></button>
                        <button class="delete-button" onclick="deletePost(${post.id})"><i class="fas fa-trash"></i></button>
                    </div>` : '';
                div.innerHTML = `<div class="post-content">${post.content} ${mediaHtml}</div><div class="post-actions"><span>${post.date}</span>${buttonsHtml}</div>`;
                container.appendChild(div);
            });
        }

        function editPost(id) {
            if(isLocked || !config.token) return;
            const post = appData.posts.find(p => p.id === id); if(!post) return;
            editingId = id; quill.root.innerHTML = post.content; tempBase64 = post.media; tempMediaType = post.mediaType;
            if(tempMediaType) document.getElementById(`upload${tempMediaType.charAt(0).toUpperCase() + tempMediaType.slice(1)}Button`).classList.add('file-selected');
            document.getElementById('postButton').style.display = 'none'; document.getElementById('updateButton').style.display = 'inline-block'; document.getElementById('cancelEditButton').style.display = 'inline-block';
            window.scrollTo(0,0); document.getElementById('mainTextEditor').classList.remove('locked-hidden');
        }
        function cancelEdit() {
            editingId = null; quill.setContents([]); tempBase64 = null;
            document.querySelectorAll('.upload-buttons button').forEach(b => b.classList.remove('file-selected'));
            document.getElementById('postButton').style.display = 'inline-block'; document.getElementById('updateButton').style.display = 'none'; document.getElementById('cancelEditButton').style.display = 'none';
        }
        function deletePost(id) {
            if(isLocked || !config.token) return;
            if(confirm("Delete this post?")) {
                appData.posts = appData.posts.filter(p => p.id !== id); appData.liked = appData.liked.filter(lid => lid !== id);
                appData.playlists.forEach(pl => { pl.postIds = pl.postIds.filter(pid => pid !== id); });
                renderPosts(); saveToGithub();
            }
        }
        function toggleLike(id) {
            if(isLocked || !config.token) return;
            if (appData.liked.includes(id)) appData.liked = appData.liked.filter(lid => lid !== id); else appData.liked.push(id);
            renderPosts(); saveToGithub();
        }

        // --- Playlist / Library ---
        function openPlaylistModal() {
            const list = document.getElementById('playlistSelectionList'); list.innerHTML = '';
            if(appData.posts.length === 0) list.innerHTML = '<p style="color:#666; padding:10px;">No posts to add.</p>';
            else {
                appData.posts.forEach(post => {
                    const div = document.createElement('div'); div.className = 'playlist-option';
                    const tempDiv = document.createElement('div'); tempDiv.innerHTML = post.content;
                    const text = tempDiv.textContent.substring(0, 40) || "Media Post (" + post.date + ")";
                    div.innerHTML = `<input type="checkbox" id="pl_post_${post.id}" value="${post.id}"><label for="pl_post_${post.id}">${text}</label>`;
                    list.appendChild(div);
                });
            }
            document.getElementById('playlistNameInput').value = ''; document.getElementById('playlistModal').style.display = 'flex';
        }
        function savePlaylist() {
            const name = document.getElementById('playlistNameInput').value.trim(); if(!name) return alert("Enter name");
            const selectedIds = Array.from(document.querySelectorAll('#playlistSelectionList input:checked')).map(cb => parseInt(cb.value));
            if(selectedIds.length === 0) return alert("Select at least one post");
            appData.playlists.push({ id: Date.now(), name: name, postIds: selectedIds });
            closeModal('playlistModal'); saveToGithub(); renderLibraryGrid();
        }
        function renderLibraryGrid() {
            const grid = document.getElementById('libraryGrid'); grid.innerHTML = '';
            const createCard = document.createElement('div'); createCard.className = 'playlist-card create-card';
            createCard.onclick = openPlaylistModal; createCard.innerHTML = `<i class="fas fa-plus"></i><h3>New Playlist</h3>`; grid.appendChild(createCard);
            appData.playlists.forEach(pl => {
                const card = document.createElement('div'); card.className = 'playlist-card';
                card.onclick = (e) => { if(e.target.className.includes('fa-trash')) return; viewPlaylist(pl.id); };
                const deleteIcon = !isLocked ? `<i class="fas fa-trash" style="font-size:1em; margin-top:10px; color:#dc3545; cursor:pointer;" onclick="deletePlaylist(${pl.id})"></i>` : '';
                card.innerHTML = `<i class="fas fa-list"></i><h3>${pl.name}</h3><span>${pl.postIds.length} posts</span>${deleteIcon}`;
                grid.appendChild(card);
            });
        }
        function deletePlaylist(id) {
            if(isLocked) return;
            if(confirm('Delete playlist?')) { appData.playlists = appData.playlists.filter(pl => pl.id !== id); saveToGithub(); renderLibraryGrid(); }
        }
        function viewPlaylist(id) {
            const playlist = appData.playlists.find(p => p.id === id); if(!playlist) return;
            document.getElementById('mainView').style.display = 'block'; document.getElementById('libraryView').style.display = 'none';
            document.getElementById('pageTitle').textContent = playlist.name;
            currentFilter = 'playlist-' + id; renderPosts(post => playlist.postIds.includes(post.id));
        }

        // --- Github ---
        async function connectToGithub() {
            const token = document.getElementById('ghToken').value.trim(); let gistId = document.getElementById('ghGistId').value.trim();
            if (!token) return alert("Token Required");
            closeModal('githubModal'); updateStatus('busy', 'Connecting...');
            if (!gistId) {
                try {
                    const res = await fetch('https://api.github.com/gists', { method: 'POST', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ description: "WebDiary", public: false, files: { "data.json": { content: JSON.stringify(appData) } } }) });
                    if(!res.ok) throw new Error('Failed'); const data = await res.json(); gistId = data.id; alert("New Cloud ID: " + gistId);
                } catch(e) { return updateStatus('error', 'Failed'); }
            }
            config = { token, gistId }; localStorage.setItem('gh_config', JSON.stringify(config)); fetchFromGithub();
        }
        async function fetchFromGithub() {
            if(!config.token) return; updateStatus('busy', 'Syncing...');
            try {
                const res = await fetch(`https://api.github.com/gists/${config.gistId}`, { headers: { 'Authorization': `token ${config.token}` } });
                if(!res.ok) throw new Error('404'); const data = await res.json();
                if(data.files['data.json']) { appData = JSON.parse(data.files['data.json'].content); renderLibraryGrid(); renderPosts(); updateStatus('online', 'Synced'); }
            } catch(e) { updateStatus('error', 'Sync Error'); }
        }
        async function saveToGithub() {
            if(!config.token) return; updateStatus('busy', 'Saving...');
            try {
                await fetch(`https://api.github.com/gists/${config.gistId}`, { method: 'PATCH', headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { "data.json": { content: JSON.stringify(appData) } } }) });
                updateStatus('online', 'Saved');
            } catch(e) { updateStatus('error', 'Save Failed'); }
        }

        // --- SECURE DISCONNECT ---
        function logout() { localStorage.removeItem('gh_config'); location.reload(); }

        function setView(view) {
            currentFilter = null; document.getElementById('searchBarContainer').style.display = 'none'; document.getElementById('menuBar').classList.remove('open');
            if(view === 'home') { document.getElementById('pageTitle').textContent = 'Home'; document.getElementById('mainView').style.display='block'; document.getElementById('libraryView').style.display='none'; renderPosts(); }
            else if(view === 'liked') { document.getElementById('pageTitle').textContent = 'Liked Posts'; currentFilter='liked'; document.getElementById('mainView').style.display='block'; document.getElementById('libraryView').style.display='none'; renderPosts(p => appData.liked.includes(p.id)); }
            else if(view === 'library') { document.getElementById('pageTitle').textContent = 'Your Library'; document.getElementById('mainView').style.display='none'; document.getElementById('libraryView').style.display='block'; renderLibraryGrid(); }
        }
        function updateStatus(state, text) { const dot=document.getElementById('statusDot'); document.getElementById('statusText').textContent=text; dot.className='status-dot '+state; }
        function openGithubSetup() { document.getElementById('githubModal').style.display = 'flex'; document.getElementById('settingsMenu').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        document.getElementById('settingsToggle').onclick = (e) => { e.stopPropagation(); const m = document.getElementById('settingsMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
        document.body.onclick = () => document.getElementById('settingsMenu').style.display = 'none';
    </script>
</body>
</html>
